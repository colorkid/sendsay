!function(){"use strict";var e=function(){function r(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(e,t,n){return t&&r(e.prototype,t),n&&r(e,n),e}}(),a=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var n=arguments[t];for(var r in n)Object.prototype.hasOwnProperty.call(n,r)&&(e[r]=n[r])}return e},t="JS";function n(e){return(document.cookie.match("(^|; )"+e+"=([^;]*)")||0)[2]}var u=["ping","login","login.agses.challenge","sys.account.create"],r=function(){function s(){var i=this,e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:{},t=e.apiKey,n=e.apiUrl,r=void 0===n?"https://api.sendsay.ru":n,o=e.auth;!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,s),this.login=function(){var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:{},t=e.login,n=e.sublogin,r=e.password;return i.performRequest({action:"login",login:t,sublogin:n,passwd:r}).then(function(e){i.setSession(e.session)})},this.request=function(){var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:{},t=1<arguments.length&&void 0!==arguments[1]?arguments[1]:{};return(i.apiKey||i.session||!i.auth||-1!==u.indexOf(e.action)?Promise.resolve():i.login(i.auth)).then(function(){return i.performRequest(e,t)})},this.performRequest=function(t){var e=1<arguments.length&&void 0!==arguments[1]?arguments[1]:{},n=a({redirected:0},e),r=i.getRequestBody(t);return fetch(""+i.apiUrl+(i.redirect||""),{method:"POST",body:r,headers:{Accept:"application/json"}}).catch(i.catchConnectionErrors).then(i.checkStatus).then(i.parseResponse).then(function(e){return i.checkResponseErrors(t,e,n)}).then(function(e){return i.checkRedirect(t,e,n)})},this.catchConnectionErrors=function(e){throw i.callErrorHandler(e),e},this.checkStatus=function(e){if(200<=e.status&&e.status<300)return e;var t=new Error("Network response was not ok.");throw i.callErrorHandler(t),t},this.parseResponse=function(e){try{return e.json()}catch(e){throw i.callErrorHandler(e),e}},this.checkRedirect=function(e,t){var n=2<arguments.length&&void 0!==arguments[2]?arguments[2]:{};return{}.hasOwnProperty.call(t,"REDIRECT")&&n.redirected<10?(i.redirect=t.REDIRECT,i.request(e,a({},n,{redirected:n.redirected+1}))):t},this.requestNumber=(new Date).getTime(),this.apiUrl=r,this.apiKey=t,this.auth=o}return e(s,null,[{key:"getLocaleDateISOString",value:function(){var e=new Date,t=6e4*e.getTimezoneOffset();return new Date(e-t).toISOString()}}]),e(s,[{key:"setSession",value:function(e){this.session=e}},{key:"setPolicy",value:function(e){this.policy=e}},{key:"setSessionFromCookie",value:function(){var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:"sendsay_session";this.setSession(n(e))}},{key:"setPolicyFromCookie",value:function(){var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:"sendsay_policy";this.setPolicy(n(e))}},{key:"onError",value:function(e){this.errorHandler=e}},{key:"checkResponseErrors",value:function(e,t){var n=2<arguments.length&&void 0!==arguments[2]?arguments[2]:{};if("errors"in t&&!n.ignoreErrors){var r=t.errors[0];throw r.request=e,this.callErrorHandler(r),r}if("batch"===e.action&&t.result&&t.result.some(function(e){return"errors"in e})){var i=t.result.find(function(e){return"errors"in e}).errors[0];throw i.request=e,this.callErrorHandler(i),i}return t}},{key:"callErrorHandler",value:function(e){"function"==typeof this.errorHandler&&this.errorHandler(e)}},{key:"getRequestBody",value:function(e){var t="apiversion=100&json=1";return t+="&request="+encodeURIComponent(this.getRequestData(e)),t+="&request.id="+encodeURIComponent(this.getRequestId())}},{key:"getRequestData",value:function(e){var t=a({},e);return this.apiKey?t.apikey=this.apiKey:this.session&&(t.session=this.session),this.policy&&(t["lbac.policy"]=this.policy),JSON.stringify(t)}},{key:"getRequestId",value:function(){return[t,this.getUsername().toUpperCase(),"undefined"!=typeof window&&window.location?window.location.pathname:null,this.requestNumber+1,s.getLocaleDateISOString()].filter(function(e){return e}).join("_")}},{key:"getUsername",value:function(){return this.apiKey?"apikey":this.session?/^(.+?):/.test(this.session)?RegExp.$1:"unknown":"unauthorized"}}]),s}(),i=[];if("Promise"in window||i.push("Promise"),"fetch"in window||i.push("fetch"),i.length){var o=document.createElement("script");o.src="https://cdn.polyfill.io/v2/polyfill.min.js?features="+i.join(","),document.head.appendChild(o)}window.Sendsay=r}();
